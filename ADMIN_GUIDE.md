# 管理后台使用指南

本文档说明如何访问和使用Django管理后台来配置系统参数和管理数据清理策略。

---

## 📋 目录

- [访问管理后台](#访问管理后台)
- [主要功能](#主要功能)
- [数据清理策略配置](#数据清理策略配置)
- [命令行操作](#命令行操作)
- [常见问题](#常见问题)

---

## 🔐 访问管理后台

### 访问地址

**管理后台不需要单独运行**，它是Django后端服务的一部分。只要后端服务运行，管理后台就可以访问。

- **本地访问**：http://localhost:5172/admin/
- **远程访问**：http://YOUR_IP:5172/admin/（将YOUR_IP替换为实际IP地址）

### 登录凭据

**默认账号**（首次部署后自动创建）：
- **用户名**：`admin`
- **密码**：`admin123`

⚠️ **重要**：生产环境部署后请立即修改默认密码！

### 前置条件

确保后端服务正在运行：

```bash
# 检查后端服务是否运行
ps aux | grep "python.*manage.py runserver"

# 如果没有运行，启动后端服务
python manage.py runserver 0.0.0.0:5172
```

---

## 🛠️ 主要功能

登录管理后台后，您可以看到以下功能模块：

### 1. 系统配置 (System Config)

配置系统参数，包括：

#### API并发控制
- **批量翻译请求间隔**：控制翻译API调用频率（默认1.0秒）
- **最大并发翻译任务数**：同时运行的翻译任务数（默认3个）
- **任务超时时间**：翻译任务的最长执行时间（默认60分钟）
- **批量TTS请求间隔**：控制TTS API调用频率（默认2.0秒）
- **最大并发TTS任务数**：同时运行的TTS任务数（默认2个）

#### 任务监控和清理
- **启用详细日志**：记录批量操作的详细日志
- **自动清理完成的任务**：自动清理TaskMonitor记录
- **清理间隔**：TaskMonitor清理间隔（默认24小时）

#### 数据自动清理 ⚠️
- **启用数据自动清理**：开启/关闭自动清理功能（默认关闭）
- **项目清理天数**：项目多少天未更新后删除（默认1天）
- **用户清理天数**：用户多少天未登录后删除（默认7天）
- **清理执行时间**：每天执行清理的时间（默认03:00）

### 2. 任务监控 (Task Monitor)

查看批量翻译和TTS任务的执行状态：
- 任务ID和类型
- 执行进度（完成/失败段落数）
- 执行时长
- 错误信息

### 3. 用户管理 (Users)

管理系统用户：
- 查看所有注册用户
- 修改用户权限
- 重置用户密码
- 删除用户

### 4. 语音管理 (Voices)

查看用户的语音库和语音克隆记录。

---

## 🗑️ 数据清理策略配置

### 配置步骤

1. **访问管理后台**：http://YOUR_IP:5172/admin/
2. **登录**：使用管理员账号
3. **进入系统配置**：
   - 点击左侧菜单 "System Config" 或 "系统配置"
   - 点击列表中的配置记录（通常只有一条）
4. **找到"数据自动清理 ⚠️"部分**（页面下方）
5. **配置参数**：
   - ☑️ **启用数据自动清理**：勾选以启用（默认未勾选）
   - **项目清理天数**：输入数字（1-365天，默认1天）
   - **用户清理天数**：输入数字（1-365天，默认7天）
   - **清理执行时间**：选择时间（默认03:00:00）
6. **保存**：点击页面底部的"保存"按钮

### 清理规则说明

#### 过期项目清理
- **判断依据**：`Project.updated_at` < 当前时间 - N天
- **删除范围**：
  - ✅ 项目记录
  - ✅ 所有翻译段落
  - ✅ 说话人识别数据
  - ✅ 所有媒体文件（视频、音频、字幕、人脸图片等）

#### 不活跃用户清理
- **判断依据**：`User.last_login` < 当前时间 - N天
- **保护策略**：
  - ❌ **超级管理员永不删除**（`is_superuser=True`）
  - ✅ 普通用户和员工账号都会被删除
- **删除范围**：
  - ✅ 用户账号及配置
  - ✅ 用户的所有项目及关联数据
  - ✅ 用户的所有语音克隆记录
  - ✅ 所有关联媒体文件

### 配置示例截图说明

在管理后台的配置页面，您会看到类似如下的表单：

```
数据自动清理 ⚠️
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 重要：启用后将定期自动删除不活跃的项目和用户数据，此操作不可逆！
- 项目清理：删除N天未更新的项目及其所有关联数据（段落、音频文件等）
- 用户清理：删除N天未登录的普通用户及其所有数据（保留超级管理员）
- 执行时间：每天在指定时间自动执行清理（建议凌晨时段）
使用前请先运行命令测试：python manage.py cleanup_old_data --dry-run

☑ 启用数据自动清理

项目清理天数: [  1  ] （1-365天）

用户清理天数: [  7  ] （1-365天）

清理执行时间: [ 03:00:00 ]
```

---

## 💻 命令行操作

如果您有SSH访问权限，也可以通过命令行管理数据清理。

### 测试清理（推荐先执行）

```bash
# 预览将要删除的数据（不实际删除）
python manage.py cleanup_old_data --dry-run

# 示例输出：
# 🗑️  数据清理任务 【预览模式】
# ============================================================
# 清理配置：
#   - 项目清理天数: 1 天
#   - 用户清理天数: 7 天
# ============================================================
# 📦 检查过期项目（1天未更新）...
#    找到 2 个过期项目:
#    - [12] 测试项目1 (最后更新: 3天前, 用户: test_user)
#      → 关联文件: 8 个, 约 45.23 MB
# ...
```

### 执行清理

```bash
# 使用系统配置的天数执行清理
python manage.py cleanup_old_data

# 自定义天数
python manage.py cleanup_old_data --projects-days=3 --users-days=14

# 仅清理项目
python manage.py cleanup_old_data --only-projects

# 仅清理用户
python manage.py cleanup_old_data --only-users
```

### 查看定时任务

```bash
# 查看已安装的定时任务
python manage.py crontab show

# 示例输出：
# Currently active jobs in crontab:
# 41d04e61... -> ('0 3 * * *', 'django.core.management.call_command', ['cleanup_old_data'], ...)
```

### 管理定时任务

```bash
# 安装定时任务（首次启用时）
python manage.py crontab add

# 移除定时任务（禁用自动清理）
python manage.py crontab remove

# 重新安装（修改配置后）
python manage.py crontab remove
python manage.py crontab add
```

---

## ❓ 常见问题

### Q1: 管理后台打不开？

**检查清单**：
1. 后端服务是否运行？`ps aux | grep runserver`
2. 端口5172是否被占用？`lsof -i :5172`
3. 防火墙是否阻止？（远程访问）
4. URL是否正确？应该是 `http://IP:5172/admin/`（注意是5172端口，不是5173）

### Q2: 忘记管理员密码？

**解决方法**：

```bash
# 方法1：重新创建管理员（强制覆盖）
python manage.py init_admin --force

# 方法2：使用Django shell修改密码
python manage.py shell
>>> from django.contrib.auth import get_user_model
>>> User = get_user_model()
>>> admin = User.objects.get(username='admin')
>>> admin.set_password('new_password')
>>> admin.save()
>>> exit()
```

### Q3: 数据清理功能启用后，如何查看是否正常执行？

**检查方法**：

1. **查看清理日志**：
   ```bash
   # 查看最近的清理日志
   tail -f /tmp/cleanup_old_data.log
   ```

2. **查看系统日志**：
   ```bash
   # Django日志
   tail -f django.log | grep cleanup
   ```

3. **查看cron执行记录**：
   ```bash
   # 系统cron日志（Ubuntu/Debian）
   grep CRON /var/log/syslog | grep cleanup
   ```

### Q4: 如何临时禁用自动清理？

**方法1：管理后台**（推荐）
- 登录管理后台
- 进入系统配置
- 取消勾选"启用数据自动清理"
- 保存

**方法2：移除定时任务**
```bash
python manage.py crontab remove
```

### Q5: `python manage.py cleanup_old_data --dry-run` 命令是做什么的？

**作用**：
- `--dry-run` 参数表示"预演模式"或"试运行"
- 命令会执行所有查询逻辑，显示将要删除的数据
- **但不会实际删除任何数据**
- 用于在真正执行清理前预览影响范围

**使用场景**：
- ✅ 首次启用清理功能前测试
- ✅ 调整清理天数后验证效果
- ✅ 定期检查系统中有多少过期数据

**示例输出**：
```
🗑️  数据清理任务 【预览模式】
============================================================
📦 检查过期项目（1天未更新）...
   找到 5 个过期项目:
   - [10] 项目A (最后更新: 2天前)
     → 关联文件: 12 个, 约 89.5 MB
   ...

👤 检查不活跃用户（7天未登录）...
   找到 3 个不活跃用户:
   - [25] user1 (最后登录: 10天前, 项目数: 2)
   ...

============================================================
📊 清理统计:
  - 项目: 5 个
  - 用户: 3 个
  - 文件: 45 个
  - 空间: 234.5 MB
============================================================

⚠️  这是预览模式，没有实际删除任何数据。
   要执行实际清理，请去掉 --dry-run 参数
```

### Q6: 数据被误删了怎么办？

**预防措施**（重要！）：
- ⚠️ 数据删除**不可恢复**
- ✅ 启用前务必使用 `--dry-run` 测试
- ✅ 生产环境定期备份数据库：
  ```bash
  # SQLite备份
  cp db.sqlite3 db.sqlite3.backup.$(date +%Y%m%d)

  # 或导出JSON
  python manage.py dumpdata > backup_$(date +%Y%m%d).json
  ```
- ✅ 提醒用户及时导出重要项目的翻译结果

**恢复方法**：
- 如有数据库备份，可恢复到备份时的状态
- 如无备份，数据无法恢复

---

## 📚 相关文档

- [README.md](./README.md) - 系统完整使用文档
- [数据清理策略章节](./README.md#🗑️-数据清理策略-data-cleanup-policy) - 详细的清理策略说明
- [Django Admin官方文档](https://docs.djangoproject.com/en/5.2/ref/contrib/admin/) - Django管理后台文档

---

## 🔒 安全建议

1. **修改默认密码**：首次部署后立即修改admin账号密码
2. **限制访问**：生产环境建议配置防火墙，仅允许特定IP访问管理后台
3. **定期备份**：启用自动清理功能后，务必建立数据库备份机制
4. **监控日志**：定期查看清理日志，确保清理符合预期
5. **测试先行**：任何参数调整后，先用 `--dry-run` 验证

---

**Built with Django Admin** | Last Updated: 2025-01-11
