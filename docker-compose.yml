version: '3.8'

services:
  minimax_dubbing:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROXY_URL: http://pac-internal.xaminim.com:3129
        NO_PROXY: localhost,127.0.0.1,*.xaminim.com,10.0.0.0/8
    image: minimax_dubbing:latest
    container_name: minimax_dubbing
    restart: unless-stopped

    # Ports
    ports:
      - "5172:5172"  # Backend API
      - "5173:5173"  # Frontend

    # Volumes for persistent data
    volumes:
      - ./data/media:/app/media
      - ./data/db.sqlite3:/app/db.sqlite3
      - model_cache:/root/.cache/torch

    # tmpfs for performance (uses 10% of system memory = 200GB)
    tmpfs:
      - /tmp:size=200g,mode=1777

    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - DJANGO_SETTINGS_MODULE=backend.settings
      - DEBUG=False
      - ALLOWED_HOSTS=*

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5172/api/auth/test-auth/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

# Named volumes
volumes:
  model_cache:
    driver: local
